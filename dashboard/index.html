<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Brew Fridge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.2.19.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
    <script src="https://d3js.org/d3.v3.js"></script>
    <script type="text/javascript" src="https://rawgit.com/masayuki0812/c3/master/c3.js"></script>
    <link rel="stylesheet" href="https://rawgit.com/masayuki0812/c3/master/c3.css">


    <script type="text/javascript">
        $(function(){
            // Initialize the Amazon Cognito credentials provider
            AWS.config.region = 'ap-southeast-2';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'ap-southeast-2:375b85ca-b8da-430b-b595-afd69d8297b4',
            });

            var docClient = new AWS.DynamoDB.DocumentClient();

            var brewNodeUuid = 'b1f85ed9-78a7-40e0-b695-be3c0fd8a95b';
            var hoursBack = 24;

            // Generating a string of the last X hours back
            var ts = new Date().getTime();
            var tsYesterday = (ts - (hoursBack * 3600) * 1000);
            var d = new Date(tsYesterday);
            var yesterdayDateString = d.getFullYear() + '-'
                + ('0' + (d.getMonth()+1)).slice(-2) + '-'
                + ('0' + d.getDate()).slice(-2) + 'T'
                + ('0' + (d.getHours()+1)).slice(-2) + ':';

            // DynamoDB Query
            var params = {
                TableName: "Event",
                Limit: 50000,
                ConsistentRead: false,
                ScanIndexForward: true,
                ExpressionAttributeValues:{
                    ":brew_node_uuid": brewNodeUuid,
                    ":start_date":yesterdayDateString,
                },
                KeyConditionExpression :
                    "brewNodeUuid = :brew_node_uuid AND createdAt >= :start_date"
            }

            docClient.query(params, function(err, data) {

                if (err) {
                    console.log(err, err.stack);
                } else {

                    var rows = [];
                    data.Items.forEach(function (item) {
                        var row = {};
                        row.date = item.createdAt;
                        row[item.type] = item.value;
                        rows.push(row);
                    });

                    var chart = c3.generate({
                        bindto: '#chart',

                        data: {
                            x: 'date',
                            xFormat: '%Y-%m-%dT%H:%M:%S.%LZ',
                            json: rows,
                            keys: {
                                x: 'date',
                                value: [ "temperature_reading", "relay_status_change" ]
                            }
                        },
                        zoom: {
                            enabled: true
                        },
                        point: {
                            show: false
                        },
                        axis: {
                            x: {
                                type: 'timeseries',
                                tick: {
                                    format: '%Y-%m-%d %I%p'
                                }
                            }
                        },

                        line: {
                            connectNull: true
                        }
                    });
                }
            });
       });
    </script>
</head>
<body>

<div id="chart"></div>

</body>
</html>
